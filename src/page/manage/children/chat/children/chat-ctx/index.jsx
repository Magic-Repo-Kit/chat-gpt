import React, { useState, useRef, useEffect, useContext } from 'react';
import '../../index.scss';
import './chat.scss';
import sseRequest from '@/request/sseRequest';
import TextLoading from '@/components/text-loading';
import MarkdownRenderer from '@/components/MarkdownRenderer';
import { DarkModeContext } from '@/components/DarkModeProvider'; //Â§úÈó¥Ê®°Âºè
// import { throttle } from 'lodash'; //lodash ËäÇÊµÅÂáΩÊï∞
import ajax from '@/request';

// ÂõæÁâá
import userHead from '@/assets/images/user-head.png';
import botHead from '@/assets/images/bot-head.png';
import mrkLogo from '@/assets/images/logo-mrk.png';
// antdÁªÑ‰ª∂
import { Input, Select, Badge } from 'antd';

const { TextArea } = Input;

function ChatCtx() {
  //  ÂÖ±‰∫´ÂèÇÊï∞
  const { darkMode } = useContext(DarkModeContext);

  const [roleParams, setRoleParams] = useState({
    // ËßíËâ≤ÂàóË°®ÂèÇÊï∞
    pageNo: 1,
    pageSize: 100,
    keywords: '',
  });

  const [roleList, setRoleList] = useState([]); // ËßíËâ≤ÂàóË°®
  const [roleImg, setRoleImg] = useState(''); // ËßíËâ≤Â§¥ÂÉè
  const [roleName, setRoleName] = useState(''); // ËßíËâ≤ÂßìÂêç
  const [roleDescription, setDescription] = useState(''); // ËßíËâ≤ÂäüËÉΩÊèèËø∞
  const [roleModel, setRoleModel] = useState(''); // ËßíËâ≤Âü∫‰∫éÊ®°Âûã
  const [roleConversationStarters, setConversationStarters] = useState([
    'Â∏ÆÊàëÁî®PythonÂÆûÁé∞‰∏Ä‰∏™ËÆ°Êï∞Âô®',
    'ÊàëÊÉ≥ÂÜô‰∏™Âπ¥ÁªàÊä•Âëä',
    '‰ªÄ‰πàÊòØÈáèÂ≠êÂäõÂ≠¶Ôºü',
  ]); // ËØïËØïËøôÊ†∑ÈóÆ

  // const [msgValue, setMsgValue] = useState(''); //ÂèëÈÄÅÊ∂àÊÅØ
  const [isExtended, setIsExtended] = useState(false); // Êâ©Â±ïÊòØÂê¶ÊòæÁ§∫

  const [messages, setMessages] = useState([]); // ËÅäÂ§©Ê∂àÊÅØ
  const [sumStr, setSumStr] = useState(''); //ËÅäÂ§©Ê∂àÊÅØ - ‰∏¥Êó∂Â≠òÂÇ®
  const [isLoading, setIsLoading] = useState(false); // ÊòØÂê¶Á≠âÂæÖ
  const chatMainRef = useRef(null);

  const [chatParams, setChatParams] = useState({
    content: '', //	ÂØπËØùÂÜÖÂÆπ
    roleId: '1', //ËßíËâ≤id , ÈªòËÆ§1 Ôºåmrk-3.5
    conversationId: 'd08b777e-f5c2-493f-82ae-060731d1ea80', // ‰ºöËØùid[‰∏ç‰º†ÂºÄÂßãÊñ∞ÁöÑ‰ºöËØù]
    isContext: 2, //ÊòØÂê¶ÂºÄÂêØ‰∏ä‰∏ãÊñá[1:ÂÖ≥Èó≠ 2:ÂºÄÂêØ]
    contextLength: 30, //‰∏ä‰∏ãÊñáÈïøÂ∫¶ÈóÆÁ≠îÂØπÊï∞Èáè(Âè™ÊúâÂºÄÂêØ‰∏ä‰∏ãÊñáÁîüÊïà)[ÈªòËÆ§20ÔºåËåÉÂõ¥1-100]
    isOnline: 1, //ÊòØÂê¶ËÅîÁΩë[1:ÂÖ≥Èó≠ 2:ÂºÄÂêØ]
  });

  // ÈòªÊ≠¢ÈªòËÆ§ÁöÑÊç¢Ë°å,(Enter-ÂèëÈÄÅ),(Shift + Enter - Êç¢Ë°å)
  const handleKeyDown = (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleRequestMessage();
    }
  };

  // Ëé∑ÂèñËßíËâ≤ÂàóË°®
  const getRoleList = async () => {
    try {
      const res = await ajax.get(`/chat/role/list-page`, roleParams);
      if (res.code === 200) {
        if (res.data) {
          const tempRoleList = res.data.list
            ? res.data.list.map((role) => ({
                value: role.id,
                label: role.name,
                description: role.description,
                imageUrl: role.imageUrl,
              }))
            : [];
          setRoleList(tempRoleList);
        }
      }
    } catch (error) {
      console.log('üöÄ ~ getFileList ~ error:', error || 'Ëé∑ÂèñÊ®°ÂûãÂàóË°®Â§±Ë¥•');
    }
  };
  // Ëé∑ÂèñËßíËâ≤ËØ¶ÊÉÖ
  const getRoleDetail = async (roleId) => {
    const id = roleId || chatParams.roleId;
    try {
      const res = await ajax.get(`/chat/role/detail/${id}`);
      if (res.code === 200) {
        if (res.data) {
          console.log('üöÄ ~ getRoleDetail ~ res.data:', res.data);
          // ËßíËâ≤ÁÆÄ‰ªã
          setRoleName(res.data.name);
          setDescription(res.data.description);
          setRoleImg(res.data.imageUrl);
          setRoleImg(res.data.imageUrl);
          setRoleModel(res.data.modelName);
          if (
            res.data.conversationStarters &&
            res.data.conversationStarters.length > 0
          ) {
            setConversationStarters(res.data.conversationStarters);
          }
        }
      }
    } catch (error) {
      console.log('üöÄ ~ getFileList ~ error:', error || 'Ëé∑ÂèñËßíËâ≤ËØ¶ÊÉÖÂ§±Ë¥•');
    }
  };

  // ÂàáÊç¢ËßíËâ≤
  const handleChangeSelect = (value) => {
    setChatParams((prevParams) => ({
      ...prevParams,
      roleId: value,
    }));
    getRoleDetail(value);
  };
  // Âø´Êç∑ÊèêÈóÆ
  const handleFastQuestion = async (question) => {
    console.log('üöÄ ~ handleFastQuestion ~ question:', question);

    if (question.trim() !== '') {
      // Êõ¥Êñ∞Ê∂àÊÅØÊòæÁ§∫Êï∞ÁªÑ - user
      setMessages((prevMessages) => [
        ...prevMessages,
        { message: question, type: 1 },
      ]);

      setIsLoading(true);

      // ËØ∑Ê±Ç
      sendMessage(question);
    }
  };

  // Â§ÑÁêÜËØ∑Ê±ÇÊó∂ÁöÑÊ∂àÊÅØ
  const handleRequestMessage = () => {
    // ËøáÊª§Á©∫Ê†º
    if (chatParams.content.trim() === '') {
      setChatParams((prevParams) => ({
        ...prevParams,
        content: '',
      }));
      return;
    }
    if (isLoading) {
      return;
    }

    if (chatParams.content.trim() !== '') {
      // Êõ¥Êñ∞Ê∂àÊÅØÊòæÁ§∫Êï∞ÁªÑ - user
      setMessages((prevMessages) => [
        ...prevMessages,
        { message: chatParams.content, type: 1 },
      ]);
      // ÂèëÈÄÅ‰πãÂêéÊ∏ÖÊéâchatParams
      setChatParams((prevParams) => ({
        ...prevParams,
        content: '',
      }));
      setIsLoading(true);

      // ËØ∑Ê±Ç
      sendMessage();
    }
  };
  // ÂèëÈÄÅÊ∂àÊÅØÊé•Âè£
  const sendMessage = async (question) => {
    // SSE ÊàêÂäü-ÂõûË∞ÉÂáΩÊï∞
    const onMessage = (event) => {
      if (event.isEnd) {
        console.log('ÁªìÊùü');
        setSumStr(''); //Ê∏ÖÁ©∫‰∏¥Êó∂Â≠òÂÇ®
        let newMessage = { message: event.message, type: 2 };
        handleReceiveMessage(newMessage);
        return;
      } else {
        if (event.message) {
          // Â≠óÁ¨¶‰∏≤Á¥ØÂä†
          setSumStr((prevSumStr) => prevSumStr + event.message);

          // setSumStrÊãºÊé•ÁöÑÊó∂ÂÄô‰πüÊªöÂä®
          scrollToBottom();
        }
      }
    };
    const onMyError = (error) => {
      console.log('ËØ∑Ê±ÇÂºÇÂ∏∏', error);
      //  Â∞ÜÊúÄÂêé‰∏ÄÊù°Ê∂àÊÅØÊ†áËÆ∞‰∏∫ isErrorÔºàÊèêÈóÆÈÇ£Êù°Ôºâ

      // setMessages((prevMessages) => {
      //   const lastMessageIndex = prevMessages.length - 1;
      //   const newMessages = prevMessages.slice();
      //   newMessages[lastMessageIndex] = {
      //     ...newMessages[lastMessageIndex],
      //     isError: true,
      //   };
      //   return newMessages;
      // });

      //ÂõûÂ§çÂ§±Ë¥•
      let newMessage = {
        message: 'ÁΩëÁªúÊúâÁÇπ‰∏çÂ•ΩÔºåËØ∑ËØïËØïÈáçÊñ∞ÊèêÈóÆ',
        type: 2,
        isError: true,
      };
      handleReceiveMessage(newMessage);
    };

    // Ë∞ÉÁî®SSEÂáΩÊï∞
    if (question) {
      // Âø´ÈÄüÊèêÈóÆ
      sseRequest(
        '/chat/gpt/chat-role',
        { ...chatParams, content: question },
        onMessage,
        setIsLoading,
        onMyError
      );
    } else {
      sseRequest(
        '/chat/gpt/chat-role',
        chatParams,
        onMessage,
        setIsLoading,
        onMyError
      );
    }
  };

  // Â§ÑÁêÜÊé•Êî∂Âà∞ÁöÑÊ∂àÊÅØ
  const handleReceiveMessage = (messageDiv) => {
    // ËøáÊª§ isError ‰∏∫ true ÁöÑÈ°πÔºåÂπ∂Ê∑ªÂä†ÁªìÊùüÊ∂àÊÅØÂà∞Êï∞ÁªÑÊú´Â∞æ
    // setMessages((prevMessages) => {
    //   const filteredMessages = prevMessages.filter((item) => !item.isError);
    //   return [...filteredMessages, messageDiv];
    // });

    // Êõ¥Êñ∞Ê∂àÊÅØÊï∞ÁªÑ - bot
    setMessages((prevMessages) => [...prevMessages, messageDiv]);
  };

  // Ëá™Âä®ÊªöÂä®Âà∞Â∫ïÈÉ®
  const scrollToBottom = () => {
    chatMainRef.current.scrollTop = chatMainRef.current.scrollHeight;
  };
  useEffect(() => {
    scrollToBottom(); //messagesÊï∞ÁªÑÊúâÂèòÂåñÂ∞±ÊªöÂä®
  }, [messages]);
  useEffect(() => {
    getRoleList();
    getRoleDetail();
  }, []);

  return (
    <div className={`chat-container ${darkMode ? 'dark-mode' : ''}`}>
      <div className="chat-select-btn">
        <Select
          defaultValue="1"
          onChange={handleChangeSelect}
          options={roleList}
        />
      </div>

      {/* ËÅäÂ§© */}
      <main ref={chatMainRef}>
        {messages && messages.length > 0 ? (
          <div className="chat-chat-main">
            {messages.map((item, index) => {
              return (
                <div
                  key={index}
                  className={item.type === 1 ? 'user-msg' : 'bot-msg'}
                >
                  {/* Â§¥ÂÉè-bot */}
                  {item.type === 1 ? (
                    ''
                  ) : (
                    <img className="bot-head" src={roleImg || botHead} />
                  )}

                  {/* ËÅäÂ§©ÂÜÖÂÆπ */}
                  <div className="msg-item">
                    <MarkdownRenderer markdown={item.message} />
                    {/* {item.message} */}
                    {/* Âà∑Êñ∞ËØ∑Ê±Ç */}
                    {/* {item.isError && index === messages.length - 1 ? (
                    <div
                      className="msg-refush"
                      onClick={throttle(sendMessage, 3000)}
                    >
                      <i className="iconfont mr-refresh-full"></i>
                    </div>
                  ) : (
                    ''
                  )} */}
                  </div>

                  {/* Â§¥ÂÉè-user */}
                  {item.type === 1 ? (
                    <img className="user-head" src={userHead} />
                  ) : (
                    ''
                  )}
                </div>
              );
            })}
            {isLoading && (
              <div className={`bot-msg ${isLoading ? '' : 'hide'}`}>
                <img className="bot-head" src={roleImg || botHead} />
                {/* <div className="msg-item">{sumStr || <TextLoading />}</div> */}
                <div className="msg-item">
                  {sumStr ? (
                    <MarkdownRenderer markdown={sumStr} />
                  ) : (
                    <div style={{ paddingBottom: 8 }}>
                      <TextLoading />
                    </div>
                  )}
                </div>
              </div>
            )}
          </div>
        ) : (
          // Ê≤°ÊúâÊ∂àÊÅØÊó∂
          <>
            {/* ‰∫∫Áâ©‰ªãÁªç */}

            <div className="chat-prompt-box">
              {/* ËßíËâ≤‰ªãÁªç */}
              <Badge.Ribbon text="ÁÆÄ‰ªã" color="#4f46e5">
                <div className="chat-prompt-role">
                  <div className="chat-prompt-role-left font-family-dingding">
                    <div>
                      <div className="role-info-name single-omit">
                        <i className="iconfont mr-taocanbanben"></i>
                        <span>{roleName}</span>
                      </div>
                      <div className="role-info-ability multiple-omit">
                        {roleDescription ||
                          '‰∏Ä‰∏™ÂäüËÉΩÂº∫Â§ßÁöÑAIÂä©ÊâãÔºåÂ∏Æ‰Ω†Ëß£ÂÜ≥ÂêÑÁßçÈóÆÈ¢ò„ÄÇÂ§öÊ®°ÊÄÅ‰∫∫Â∑•Êô∫ËÉΩÔºÅ'}
                      </div>
                    </div>

                    <div className="role-info-author">
                      <div className="role-info-title single-omit">
                        <span className="role-info-model">{roleModel}</span>
                        <span className="role-info-model">Creative</span>
                        <span className="role-info-model">Âàõ‰Ωú</span>
                      </div>
                      <div className="flx-align-center single-omit">
                        <span>‰ΩúËÄÖÔºö</span>
                        <img src={userHead} />
                        <span>Êó†ÊïåÁÆ°ÁêÜÂëò</span>
                      </div>
                    </div>
                  </div>
                  <div className="chat-prompt-role-right font-family-dingding">
                    <div className="role-info-head">
                      <img src={roleImg || botHead} />
                    </div>
                    <div className="role-info-collect flx-justify-between">
                      {/* Êî∂Ëóè */}
                      <div className="role-info-star flx-center">
                        <i className="iconfont mr-shoucangtianchong"></i>
                        <span>406</span>
                      </div>
                      {/* ÁÇπËµû */}
                      <div className="role-info-star flx-center">
                        <i className="iconfont mr-xihuantianchong"></i>
                        <span>523</span>
                      </div>
                    </div>
                  </div>
                </div>
              </Badge.Ribbon>

              {/* È¢ÑËÆæÈóÆÈ¢ò */}
              <div className="chat-prompt-question-box">
                <div className="chat-prompt-title font-family-dingding">
                  ËØïËØïËøôÊ†∑ÈóÆ
                </div>
                <div className="chat-question user-select">
                  {roleConversationStarters &&
                  roleConversationStarters.length > 0
                    ? roleConversationStarters.map((item, index) => (
                        <span
                          key={index}
                          onClick={() => handleFastQuestion(item)}
                        >
                          {item}
                        </span>
                      ))
                    : ''}
                </div>
              </div>
            </div>

            <div className="chat-chat-empty">
              <div className="chat-empty-icon flx-center user-select">
                <img src={mrkLogo} className="mrkLogo" />
              </div>
            </div>
          </>
        )}
      </main>

      <footer className="chat-container-footer">
        <div className="chat-text-send-container">
          {/* ËæìÂÖ• */}
          <div className="chat-text-area-box">
            <TextArea
              style={{
                color: darkMode ? '#fff' : '',
              }}
              value={chatParams.content}
              className={`remove-default-textarea ${
                darkMode ? 'custom-placeholder' : ''
              }`}
              maxLength={50000}
              placeholder="Shift + EnterÊç¢Ë°å"
              onChange={(e) =>
                setChatParams((prevParams) => ({
                  ...prevParams,
                  content: e.target.value,
                }))
              }
              autoSize={{ maxRows: 10 }}
              onFocus={() => setIsExtended(false)}
              onKeyDown={handleKeyDown} // ÁõëÂê¨ÈîÆÁõòÊåâÈîÆ
            />
            {chatParams.content ? (
              ''
            ) : (
              <div className="chat-footer-icon chat-footer-sound">
                <i className="iconfont mr-shengboyuyinxiaoxi"></i>
              </div>
            )}
          </div>
          {/* Ê∑ªÂä† / ÂèëÈÄÅÂõæÊ†á */}

          <div className={`chat-footer-icon chat-footer-send click-jump `}>
            {isLoading ? (
              <i className="iconfont mr-stop stop-scale"></i>
            ) : (
              <>
                {chatParams.content ? (
                  <i
                    className="iconfont mr-gongzuo-jiantoufasonganniu"
                    onClick={handleRequestMessage}
                  ></i>
                ) : (
                  <div
                    className={`${
                      isExtended ? 'add-rotate' : 'reverse-rotate'
                    }`}
                  >
                    <i
                      className="iconfont mr-jia"
                      onClick={() => setIsExtended(!isExtended)}
                    ></i>
                  </div>
                )}
              </>
            )}
          </div>
        </div>
        {/* Â±ïÂºÄÂäüËÉΩ */}
        <div
          className={`chat-text-extend-container ${
            isExtended ? 'isExtended' : ''
          }`}
        >
          <div className="chat-text-extend-item flx-center">
            <div>
              <i className="iconfont mr-tupian1"></i>
            </div>
            <div>ÁÖßÁâá</div>
          </div>
          <div className="chat-text-extend-item flx-center">
            <div>
              <i
                className="iconfont mr-wenjianjia1"
                style={{ fontSize: 30 }}
              ></i>
            </div>
            <div>Êñá‰ª∂</div>
          </div>
          <div className="chat-text-extend-item flx-center">
            <div>
              <i
                className="iconfont mr-yuyinshuru1"
                style={{ fontSize: 28 }}
              ></i>
            </div>
            <div>ËØ≠Èü≥ËæìÂÖ•</div>
          </div>
          <div className="chat-text-extend-item flx-center">
            <div>
              <i className="iconfont mr-paishe" style={{ fontSize: 28 }}></i>
            </div>
            <div>ÊãçÊëÑ</div>
          </div>
        </div>
      </footer>
    </div>
  );
}

export default ChatCtx;
